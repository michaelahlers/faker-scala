version: '{build}'

platform:
  - x64

image:
  - macOS
  - Ubuntu
  - Visual Studio 2019

stack:
  - jdk 8
#  - jdk 11
#  - jdk 15

environment:
  APPVEYOR_SAVE_CACHE_ON_ERROR: true

build_script:
  - sh: 'echo $JAVA_HOME'
  - cmd: 'echo %JAVA_HOME%'
  - 'java -version'
  - sh: '$HOME/cs launch sbt -- +test:compile'
  - cmd: 'sbt +test:compile'

test_script:
  - sh: '$HOME/cs launch sbt -- +test'
  - cmd: 'sbt +test'

for:

  - matrix:
      only:
        - image: macOS
          stack: jdk 8

    environment:
      JAVA_VERSION: 1.8

    # https://github.com/scala/scala-lang/pull/1130
    # https://github.com/coursier/coursier/issues/1714
    # https://contributors.scala-lang.org/t/easier-scala-installation/4326
    install: &install-macos
      - '/usr/libexec/java_home -V'
      - 'export JAVA_HOME=$(/usr/libexec/java_home)'
      - 'export PATH=$JAVA_HOME/bin:$PATH'
      - 'curl -Lo $HOME/cs https://git.io/coursier-cli-macos'
      - 'chmod +x $HOME/cs'

    # https://get-coursier.io/docs/cache
    cache: &cache-macos
#      - '$HOME/Library/Caches/Homebrew -> .appveyor.yml'
      - '$HOME/Library/Caches/Coursier/v1 -> **/dependencies.sbt, project/*'
      - '$HOME/.ivy2 -> **/dependencies.sbt, project/*'
      - '$HOME/.sbt -> **/dependencies.sbt, project/*'

  - matrix:
      only:
        - image: macOS
          stack: jdk 11

    environment:
      JAVA_VERSION: 11

    install: *install-macos

    cache: *cache-macos

  - matrix:
      only:
        - image: macOS
          stack: jdk 15

    environment:
      JAVA_VERSION: 15

    install: *install-macos

    cache: *cache-macos

  - matrix:
      only:
        - image: Ubuntu

    # https://scala-sbt.org/1.x/docs/Installing-sbt-on-Linux.html
    # https://github.com/scala/scala-lang/pull/1130
    # https://github.com/coursier/coursier/issues/1714
    # https://contributors.scala-lang.org/t/easier-scala-installation/4326
    install: &install-linux
      - 'curl -Lo $HOME/cs https://git.io/coursier-cli-linux'
      - 'chmod +x $HOME/cs'

    # https://get-coursier.io/docs/cache
    cache: &cache-linux
#      - '/var/cache/apt/archives -> .appveyor.yml'
      - '$HOME/.cache/coursier/v1 -> **/dependencies.sbt, project/*'
      - '$HOME/.ivy2 -> **/dependencies.sbt, project/*'
      - '$HOME/.sbt -> **/dependencies.sbt, project/*'

  - matrix:
      only:
        - image: Visual Studio 2019
          stack: jdk 8

    environment:
      JAVA_VERSION: '1.8'
      JAVA_HOME: 'C:\Program Files\Java\jdk1.8.0'

    # https://scala-sbt.org/1.x/docs/Installing-sbt-on-Windows.html
    install: &install-windows
      - 'SET PATH=%JAVA_HOME%\bin;%PATH%'
      - 'SET PATH=%PROGRAMFILES(X86)%\sbt\bin;%PATH%'
      - 'choco install sbt'

    # https://appveyor.com/docs/build-cache/
    # https://docs.microsoft.com/en-us/windows/deployment/usmt/usmt-recognized-environment-variables
    # https://get-coursier.io/docs/cache
    cache: &cache-windows
      - '%LOCALAPPDATA%\Temp\1\chocolatey\sbt -> .appveyor.yml'
      - '%LOCALAPPDATA%\Coursier\Cache\v1 -> **\dependencies.sbt, project\*'
      - '%USERPROFILE%\.ivy2 -> **\dependencies.sbt, project\*'
      - '%USERPROFILE%\.sbt -> **\dependencies.sbt, project\*'

  -
    matrix:
      only:
        - image: Visual Studio 2019
          stack: jdk 11

    environment:
      JAVA_VERSION: '11'
      JAVA_HOME: 'C:\Program Files\Java\jdk11'

    install: *install-windows

    cache: *cache-windows

  - matrix:
      only:
        - image: Visual Studio 2019
          stack: jdk 15

    environment:
      JAVA_VERSION: '15'
      JAVA_HOME: 'C:\Program Files\Java\jdk15'

    install: *install-windows

    cache: *cache-windows
