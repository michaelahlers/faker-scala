version: '0.1.0-{build}'

skip_branch_with_pr: true
skip_tags: true

platform:
  - x64

image:
  - macOS
  - Ubuntu
  - Visual Studio 2019

stack:
  - jdk 8
  - jdk 11
  - jdk 15

environment:
  APPVEYOR_SAVE_CACHE_ON_ERROR: true
  PUBLISH_TO_URL: 'file:published'

artifacts:
  - path: 'published.zip'
    type: zip

build_script:
  - sh: 'export'
  - sh: 'echo "JAVA_HOME=$JAVA_HOME"'
  - cmd: 'echo "JAVA_HOME=%JAVA_HOME%"'
  - 'java -version'
  - 'sbt faker-plugins/Test/compile'
  - 'sbt faker-plugins/IntegrationTest/compile'
  - 'sbt +Test/compile'

test_script:
  - 'sbt faker-plugins/Test/test'
  - 'sbt faker-plugins/IntegrationTest/test'
  - 'sbt +Test/test'

after_test:
  - 'sbt faker-plugins/publish'
  - 'sbt +publish'
  - sh: '7z a published.zip "$APPVEYOR_BUILD_FOLDER/published/*"'
  - cmd: '7z a published.zip "%APPVEYOR_BUILD_FOLDER%\published\*"'

for:

  - matrix:
      only:
        - image: macOS
          stack: jdk 8

    environment:
      JAVA_VERSION: 1.8

    install: &install-macos
      - '/usr/libexec/java_home -V'
      - 'export JAVA_HOME=$(/usr/libexec/java_home)'
      - 'export PATH=$JAVA_HOME/bin:$PATH'
      - 'brew install sbt'

    # https://get-coursier.io/docs/cache
    cache: &cache-macos
#      - '$HOME/Library/Caches/Homebrew -> .appveyor.yml'
      - '$HOME/Library/Caches/Coursier/v1 -> **/dependencies.sbt, project/*'
      - '$HOME/.ivy2 -> **/dependencies.sbt, project/*'
      - '$HOME/.sbt -> **/dependencies.sbt, project/*'

  - matrix:
      only:
        - image: macOS
          stack: jdk 11

    environment:
      JAVA_VERSION: 11
      PUBLISH_TO_URL: 'file:published'

    install: *install-macos

    cache: *cache-macos

  - matrix:
      only:
        - image: macOS
          stack: jdk 15

    environment:
      JAVA_VERSION: 15
      PUBLISH_TO_URL: 'file:published'

    artifacts:
      - path: 'published/**'

    install: *install-macos

    cache: *cache-macos

  - matrix:
      only:
        - image: Ubuntu
          stack: jdk 8

    environment:
      PUBLISH_TO_URL: 'file:published'

    artifacts:
      - path: 'published/**'

    # https://scala-sbt.org/1.x/docs/Installing-sbt-on-Linux.html
    install: &install-linux
      - 'echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list'
      - 'echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | sudo tee /etc/apt/sources.list.d/sbt_old.list'
      - 'curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | sudo apt-key add'
      - 'sudo apt-get update'
      - 'sudo apt-get install sbt'

    # https://get-coursier.io/docs/cache
    cache: &cache-linux
#      - '/var/cache/apt/archives -> .appveyor.yml'
      - '$HOME/.cache/coursier/v1 -> **/dependencies.sbt, project/*'
      - '$HOME/.ivy2 -> **/dependencies.sbt, project/*'
      - '$HOME/.sbt -> **/dependencies.sbt, project/*'

    deploy:
      - provider: S3
        access_key_id:
          secure: z8mEVIKfSkpmq+WaQpy55p4MwJ4/cH7d2rEHbr+DVZQ=
        secret_access_key:
          secure: n6Vac0IBz5K1GYM5b9ZNR/cbtm+vznGhiIsB/hXXv96WyT2+00nIqX/61ZgBMw/m
        bucket: ahlers-consulting-artifacts-public
#        folder: $(APPVEYOR_PROJECT_SLUG)/$(APPVEYOR_BUILD_VERSION)
        set_public: true
        unzip: true

  - matrix:
      only:
        - image: Ubuntu

    environment:
      PUBLISH_TO_URL: 'file:published'

    artifacts:
      - path: 'published/**'

    install: *install-linux

    cache: *cache-linux

  - matrix:
      only:
        - image: Visual Studio 2019
          stack: jdk 8

    environment:
      JAVA_VERSION: '1.8'
      JAVA_HOME: 'C:\Program Files\Java\jdk1.8.0'
      PUBLISH_TO_URL: 'file:published'

    # https://scala-sbt.org/1.x/docs/Installing-sbt-on-Windows.html
    install: &install-windows
      - 'SET PATH=%JAVA_HOME%\bin;%PATH%'
      - 'SET PATH=%PROGRAMFILES(X86)%\sbt\bin;%PATH%'
      - 'choco install sbt'

    # https://appveyor.com/docs/build-cache/
    # https://docs.microsoft.com/en-us/windows/deployment/usmt/usmt-recognized-environment-variables
    # https://get-coursier.io/docs/cache
    cache: &cache-windows
#      - '%ALLUSERSAPPDATA%\chocolatey\lib -> .appveyor.yml'
      - '%LOCALAPPDATA%\Coursier\Cache\v1 -> **\dependencies.sbt, project\*'
      - '%USERPROFILE%\.ivy2 -> **\dependencies.sbt, project\*'
      - '%USERPROFILE%\.sbt -> **\dependencies.sbt, project\*'

  - matrix:
      only:
        - image: Visual Studio 2019
          stack: jdk 11

    environment:
      JAVA_VERSION: '11'
      JAVA_HOME: 'C:\Program Files\Java\jdk11'
      PUBLISH_TO_URL: 'file:published'

    install: *install-windows

    cache: *cache-windows

  - matrix:
      only:
        - image: Visual Studio 2019
          stack: jdk 15

    environment:
      JAVA_VERSION: '15'
      JAVA_HOME: 'C:\Program Files\Java\jdk15'
      PUBLISH_TO_URL: 'file:published'

    install: *install-windows

    cache: *cache-windows
